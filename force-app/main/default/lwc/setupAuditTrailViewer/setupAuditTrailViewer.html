<template>
    <lightning-card title="Setup Audit Trail" icon-name="standard:record">
        <div class="slds-var-p-around_medium">
            <!-- Filter Section -->
            <div class="slds-grid slds-gutters slds-var-m-bottom_medium slds-grid_vertical-align-end">
                <div class="slds-col slds-size_1-of-4">
                    <lightning-input type="date" label="Start Date" value={startDate} onchange={handleStartDateChange}></lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-4">
                    <lightning-input type="date" label="End Date" value={endDate} onchange={handleEndDateChange}></lightning-input>
                </div>
                <div class="slds-col slds-size_1-of-4">
                    <lightning-combobox
                        name="sectionFilter"
                        label="Filter by Section"
                        value={selectedSection}
                        placeholder="Select Section"
                        options={sectionOptions}
                        onchange={handleSectionChange}
                        disabled={isFilterDisabled}>
                    </lightning-combobox>
                </div>
                <div class="slds-col">
                    <lightning-button label="Filter Logs" variant="brand" onclick={handleFilter} disabled={isLoading}></lightning-button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <template lwc:if={isLoading}>
                <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
            </template>

            <!-- Error Message -->
            <template lwc:if={error}>
                <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
                    <span class="slds-assistive-text">error</span>
                    <h2>{error}</h2>
                </div>
            </template>

            <!-- Results Section -->
            <template lwc:if={groupedLogs}>
                <template lwc:if={hasLogs}>
                    <div class="slds-scrollable_y" style="max-height: 500px;">
                        <template for:each={groupedLogs} for:item="group">
                            <div key={group.section} class="slds-section slds-is-open">
                                <h3 class="slds-section__title slds-theme_shade">
                                    <span class="slds-truncate slds-p-horizontal_small" title={group.section}>{group.section} ({group.items.length})</span>
                                </h3>
                                <div aria-hidden="false" class="slds-section__content">
                                    <table class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_striped">
                                        <thead>
                                            <tr class="slds-line-height_reset">
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Action">Action</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Display">Display</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="User">User</div>
                                                </th>
                                                <th class="" scope="col">
                                                    <div class="slds-truncate" title="Date">Date</div>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template for:each={group.items} for:item="log">
                                                <tr key={log.Id} class="slds-hint-parent">
                                                    <td data-label="Action">
                                                        <div class="slds-truncate" title={log.Action}>{log.Action}</div>
                                                    </td>
                                                    <td data-label="Display">
                                                        <div class="slds-truncate" title={log.Display}>{log.Display}</div>
                                                    </td>
                                                    <td data-label="User">
                                                        <div class="slds-truncate" title={log.CreatedByName}>{log.CreatedByName}</div>
                                                    </td>
                                                    <td data-label="Date">
                                                        <div class="slds-truncate" title={log.CreatedDate}>
                                                            <lightning-formatted-date-time value={log.CreatedDate} year="numeric" month="numeric" day="numeric" hour="2-digit" minute="2-digit"></lightning-formatted-date-time>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
                <template lwc:else>
                    <div class="slds-text-align_center slds-var-p-around_medium">
                        <p>No logs found for the selected date range.</p>
                    </div>
                </template>
            </template>
        </div>
    </lightning-card>
</template>
